# 坦克动荡 - 多人联机模块

## 概述

这个模块为坦克动荡游戏添加了局域网多人游戏功能，支持2-4人同时游戏。采用UDP协议和主机权威模式，确保低延迟和稳定的游戏体验。

## 功能特性

- **局域网自动发现**: 无需手动输入IP地址，自动发现同一网络内的游戏房间
- **主机权威模式**: 主机运行完整游戏逻辑，客户端只发送输入，确保游戏状态一致性
- **实时同步**: 30Hz游戏状态广播，流畅的多人游戏体验
- **断线处理**: 自动检测断线并处理重连
- **兼容性**: 与现有单机游戏代码完全兼容

## 架构设计

### 网络架构
- **协议**: UDP (端口 12345-12346)
- **发现机制**: UDP广播
- **同步策略**: 主机权威 + 客户端输入转发
- **消息格式**: JSON

### 模块结构
```
multiplayer/
├── __init__.py           # 模块初始化和常量
├── udp_discovery.py      # 房间发现和广播
├── udp_host.py          # 主机端网络处理
├── udp_client.py        # 客户端网络处理
├── udp_messages.py      # 消息协议定义
├── network_views.py     # 网络游戏视图
└── README.md           # 本文档
```

## 使用方法

### 1. 启动游戏
```bash
cd tank
python main.py
```

### 2. 创建房间（主机）
1. 选择"游戏模式" → "多人联机"
2. 按 `C` 创建房间
3. 等待其他玩家加入
4. 按 `Space` 开始游戏

### 3. 加入房间（客户端）
1. 选择"游戏模式" → "多人联机"
2. 使用 `↑↓` 选择房间
3. 按 `Enter` 加入房间
4. 等待主机开始游戏

### 4. 游戏控制
- **主机玩家**: 使用 WASD 移动，Space 射击
- **客户端玩家**: 输入会自动转发到主机处理

## 技术细节

### 消息类型
- `room_advertise`: 房间广播
- `join_request`: 加入请求
- `join_response`: 加入响应
- `player_input`: 玩家输入
- `game_state`: 游戏状态
- `heartbeat`: 心跳包
- `disconnect`: 断开连接

### 网络配置
- **发现端口**: 12345
- **游戏端口**: 12346
- **广播间隔**: 2秒
- **更新频率**: 30Hz
- **超时时间**: 3秒

### 游戏状态同步
主机定期广播以下信息：
- 所有坦克的位置、角度、血量
- 所有子弹的位置、角度
- 回合信息（分数、胜负状态）

## 测试和调试

### 运行测试
```bash
cd tank
python test_multiplayer.py
```

### 运行演示
```bash
cd tank
python multiplayer_demo.py
```

### 调试模式
在代码中设置调试标志可以查看详细的网络通信日志。

## 网络要求

### 防火墙设置
确保以下端口开放：
- UDP 12345 (房间发现)
- UDP 12346 (游戏通信)

### 网络环境
- 所有设备必须在同一局域网内
- 支持UDP广播的网络环境
- 建议使用有线连接以获得最佳性能

## 故障排除

### 常见问题

**Q: 找不到房间**
A: 检查防火墙设置，确保UDP端口12345开放

**Q: 连接失败**
A: 检查网络连接，确保在同一局域网内

**Q: 游戏卡顿**
A: 检查网络延迟，建议使用有线连接

**Q: 断线频繁**
A: 检查网络稳定性，调整超时设置

### 日志查看
程序会在控制台输出详细的网络状态信息，可用于调试。

## 扩展开发

### 添加新消息类型
1. 在 `udp_messages.py` 中定义新的消息类型
2. 在 `MessageFactory` 中添加创建方法
3. 在主机和客户端中添加处理逻辑

### 自定义网络配置
修改 `__init__.py` 中的常量：
```python
DISCOVERY_PORT = 12345
GAME_PORT = 12346
GAME_UPDATE_RATE = 30
CONNECTION_TIMEOUT = 3.0
```

### 集成新游戏模式
1. 继承 `NetworkHostView` 或 `NetworkClientView`
2. 实现特定的游戏逻辑
3. 在主菜单中添加入口

## 性能优化

### 网络优化
- 只传输必要的游戏状态
- 使用差分更新减少数据量
- 客户端预测减少延迟感知

### 内存优化
- 及时清理断开的连接
- 复用消息对象
- 限制消息队列大小

## 安全考虑

### 输入验证
- 验证客户端输入的合法性
- 防止恶意输入影响游戏

### 网络安全
- 仅在可信网络环境中使用
- 考虑添加简单的身份验证

## 版本历史

- **v1.0**: 基础多人游戏功能
- 房间发现和连接
- 游戏状态同步
- 断线处理

## 贡献指南

欢迎提交问题报告和功能建议！

## 许可证

与主项目保持一致。

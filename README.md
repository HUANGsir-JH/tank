# 坦克动荡 (VSTank Project)

本项目是一个基于Python Arcade库和Pymunk物理引擎开发的2D坦克对战游戏。

## 已实现功能

*   **双人对战模式 (PVP)**：支持两名玩家在同一台电脑上进行对战。
*   **游戏流程与规则**：
    *   采用三局两胜制决定最终胜负。
    *   每回合结束后，会有明确的提示信息告知本回合胜者。
    *   回合结束后，坦克状态（位置、血量）和子弹会被重置。
    *   当有玩家率先赢得两局后，游戏结束并显示最终胜利者。
*   **坦克操控**：
    *   玩家1使用 `WASD` 键控制移动，`空格键` 射击。
    *   玩家2使用 `方向箭头键` 控制移动，`回车键` 或 `右Shift键` 射击。
    *   坦克可以前进、后退和旋转。
*   **物理与碰撞 (Pymunk集成)**：
    *   **坦克和子弹**的移动、旋转和碰撞（与墙壁、与坦克）都由Pymunk物理引擎处理。
    *   显著改善了坦克卡在墙边的问题，提供了更平滑和真实的物理反馈。
    *   通过调整Pymunk参数，优化了坦克的停止行为，减少了不必要的滑动。
    *   子弹撞墙时会根据弹性反弹，并在达到最大反弹次数后消失。
    *   子弹击中对方坦克会造成伤害并自身消失，同时正确处理了子弹不会伤害发射者自身的情况。
*   **子弹系统**：
    *   坦克可以发射子弹。
    *   子弹的飞行和碰撞行为现在完全由Pymunk物理引擎模拟。
*   **用户界面 (UI)**：
    *   游戏界面底部清晰显示双方玩家的剩余血量（通过血条表示）和当前胜场数。
    *   游戏界面顶部显示当前游戏模式和返回主菜单的提示。
*   **菜单系统**：
    *   包含主菜单，提供开始游戏和退出游戏的选项。
    *   包含模式选择菜单，用于选择游戏模式。
*   **坦克选择**：
    *   新增独立的坦克选择界面，玩家可以在开始双人对战前选择自己喜欢的坦克外观。
    *   在选择界面中，清晰标识了当前玩家选择的是哪个坦克。
*   **地图**：
    *   地图 1 (Map 1): 中央通道与S型绕行
    *   地图 2 (Map 2): H型结构与外延障碍
    *   地图 3 (Map 3): 四角方块与中央十字

## 技术栈

*   **游戏框架**: Python Arcade Library
*   **物理引擎**: Pymunk

## 开发过程亮点

1.  **基础框架搭建**：使用Arcade库快速搭建了游戏窗口、视图管理（主菜单、模式选择、游戏视图、结束视图）和基本的精灵渲染。
2.  **核心游戏逻辑实现**：
    *   实现了坦克的创建、控制（键盘输入处理）和射击功能。
    *   开发了子弹的发射、移动、边界消失及撞墙反弹机制。
    *   建立了伤害计算和生命值系统。
3.  **回合制与胜负判断**：
    *   设计并实现了三局两胜的游戏流程，包括回合间的状态重置、胜场累计。
    *   添加了回合结束时的即时反馈提示和游戏结束时的最终结果展示。
4.  **Pymunk物理引擎集成**：
    *   为游戏场景（墙壁）和动态对象（坦克）创建了Pymunk物理实体（body和shape）。
    *   将坦克的移动和旋转控制逻辑迁移到通过Pymunk的力/速度应用来实现。
    *   通过Pymunk处理坦克与墙壁、坦克与坦克之间的碰撞，取代了原有的手动碰撞检测和响应代码。
    *   调整了Pymunk的阻尼（damping）、摩擦力（friction）和施加给坦克的速度/角速度参数，以优化操控手感和解决滑动、卡墙等问题。
    *   实现了Arcade精灵显示与Pymunk物理状态的同步。
    *   **子弹物理化**：将子弹的创建、移动和碰撞处理（包括反弹、伤害、销毁）完全整合到Pymunk中，并设置了相应的碰撞处理器。
6.  **新增坦克选择界面**：
    *   实现了玩家在开始PVP游戏前选择不同坦克外观的功能。
    *   在选择界面中添加了玩家标识，提升用户体验。
7.  **用户体验优化**：
    *   根据反馈调整了UI布局、坦克大小、墙壁厚度等视觉元素。
    *   优化了回合结束时的提示，使其更友好。
    *   将窗口大小调整为 1280x720。

## 多人联机功能 (新增)

*   **局域网多人游戏**：支持2-4人同时游戏的UDP网络架构。
*   **房间发现系统**：自动发现同一局域网内的游戏房间。
*   **主机权威模式**：确保游戏状态一致性的网络同步机制。
*   **实时通信**：30Hz游戏状态广播，低延迟游戏体验。
*   **断线处理**：自动检测断线并处理重连的容错机制。

### 使用方法
1. **创建房间**：选择"多人联机" → 按 `C` 创建房间
2. **加入房间**：选择"多人联机" → 使用 `↑↓` 选择房间 → 按 `Enter` 加入
3. **开始游戏**：主机按 `Space` 开始游戏

详细文档请参考 `multiplayer/README.md`

## 测试套件

项目包含完整的测试套件，确保代码质量和功能正确性：

### 运行所有测试
```bash
cd test
python run_all_tests.py
```

### 测试类型
*   **游戏逻辑测试**：坦克、子弹、物理引擎、地图生成
*   **多人游戏测试**：消息序列化、房间发现、连接管理
*   **网络功能测试**：端口可用性、延迟、稳定性、多客户端

### 快速测试
```bash
python run_all_tests.py --quick
```

详细测试文档请参考 `test/README.md`

## 未来展望 (待办事项)

根据初始需求，未来可以继续开发以下功能：

*   **随机迷宫生成**：增加游戏地图的多样性和可玩性。
*   **道具系统**：引入如加速、加血、子弹强化等道具。
*   **玩家 vs 电脑 (PVC) 模式**：开发具有一定智能的敌人AI。
*   **音效系统**：为游戏中的各种事件（如射击、爆炸、碰撞）添加音效。
*   **代码优化与重构**：持续改进代码结构和性能。
